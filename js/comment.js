"use strict";
require.config(requireConfig),require(["jquery","tmpl","i18n","bootstrap","common","star"],function(t,e,n,i,o,r){function a(t){p(m(t,document.getElementById("upload_input").files[0].name))}function l(e){e.size>w?(alert(t.i18n.map.CommentMaxFileSize),t("#upload_input").val("")):e.size>I?(u(e),d(e,a)):(u(e),c(e,a))}function u(t){var e=window.URL||window.webkitURL,n=e.createObjectURL(t);y.push(n),g()}function c(t,e){var n=new FileReader;n.onload=function(){imgBase64=n.result,e(imgBase64)},n.readAsDataURL(t)}function d(e,n){if("undefined"==typeof FileReader)console.log("The current browser kernel does not support base64 image compression"),c(e,n);else try{var i=new FileReader;i.onload=function(e){var i=t("<img/>");i.load(function(){var t=this.height/(this.width/300),e=document.createElement("canvas"),i=e.getContext("2d"),o=0,r=0,a=0,l=0,u="";e.width=300,e.height=t,i.clearRect(0,0,300,t),this.width>300?(o=Math.round(300),r=t,a=Math.round((o-300)/2)):(r=Math.round(t),o=300,l=Math.round((r-t)/2)),i.drawImage(this,a,l,o,r);var u=e.toDataURL("image/jpeg");n(u)}),i.attr("src",e.target.result)},i.readAsDataURL(e)}catch(t){console.log("Compression failed!"),c(e,n)}}function m(t,e){for(var n=t.split(","),i=n[0].match(/:(.*?);/)[1],o=atob(n[1]),r=o.length,a=new Uint8Array(r);r--;)a[r]=o.charCodeAt(r);return new File([a],e,{type:i})}function s(t){y.pop(),y.push(o.util.commentPicUrl+t),g()}function p(e){console.log("updateImage");var n=new FormData;n.append("file",e),o.dao.uploadCommentImg(n,function(t){s(t)},null,function(){t("#upload_input").val("")})}function f(e){for(var n=[],i="",r=0;r<e.length;r++){var a=e[r];i=a.substring(a.lastIndexOf("/")+1),n.push(i)}o.dao.delCommentImg({inputParams:JSON.stringify(n)},function(){if(n&&1==n.length){for(var e=0,o=0;o<y.length;o++)if(y[o].indexOf(i)>0){e=o;break}y.splice(e,1),0==y.length?t("#comment_image_list").addClass("hide"):g()}})}function g(){t("#comment_image_list").html(t("#commentImageTempl").tmpl(y)),t("#comment_image_list").removeClass("hide"),t("#comment_image_list .icon-close").each(function(){t(this).click(function(){f([t(this).parent().find("img")[0].src])})}),y.length>=3?t("#update_layout").hide():t("#update_layout").show()}function h(e){var n=t.i18n.map.CommentContentHint;n=n.replace("%",e);var i=n.substring(0,n.indexOf(e)),o=n.substring(n.indexOf(e)+ +(""+e).length,n.length);t("#word_number").html(i+"<span>"+e+"</span>"+o)}o.initLoginStatus();var v,_=o.util.getQueryString("id"),C=o.util.getQueryString("index"),w=4194304,I=102400,y=[];!function(){t("#comment_star_input").rating({step:1,size:"xs",showClear:!1,min:0,max:5,showCaption:!1}).rating("update",5)}(),h(500),function(){window.onbeforeunload=function(t){f(y)},t("#upload_input").change(function(){var t=null,e=document.getElementById("upload_input");if(e.files)t=e.files[0],l(t);else{e.select(),e.blur();var n=document.selection.createRange().text;console.log("filePath = "+n),y.push(n),g()}}),t("#comment_content_input").bind("input propertychange",function(){h(500-t(this).val().length)}),t("#addCommentBtn").click(function(){var e=o.util.getUserId();if(!e)return void(window.location.href="../../../login.html");var n="";if(!v.cmId){var n=t("#comment_star_input").val();if(!n)return void alert(t.i18n.map.CommentNullStar)}var i=t("#comment_content_input").val();if(!i)return void alert(t.i18n.map.CommentNullContent);var r=[];if(y&&y.length>0)for(var a=0;a<y.length;a++){var l=y[a];r.push(l.substring(l.lastIndexOf("/")+1))}var u={shareimgs:r,sharevideo:"",videourl:t("#comment_video_input").val(),orderId:_,productId:v.productId,productColorId:v.productColorId,cmId:v.cmId?v.cmId:null,attrDes:v.attrDes,tEval:n,content:i,userId:e};o.dao.submitComment({inputParams:JSON.stringify(u)},function(){t("#submit_comment_success_mask").removeClass("hide")})}),t("#confirmBtn").click(function(){t("#submit_comment_success_mask").addClass("hide"),""===document.referrer?window.location.href="/":window.history.go(-1)})}(),function(e){t("#orderId").html(e),o.dao.getOrderDetail({orderId:e},function(e){t("#orderDate").html(o.util.formatOrderDateTime(e.crTime));var n=o.util.getCurrencySymbol(e.correncyCode);n||(n=o.util.getCurrencySymbol(o.util.getLocalCurrency()));var i=o.util.getAdvSource().u;i||(i=o.util.getQueryString("u"));var r="";i&&(r="?u="+i);for(var a=o.util.encodeMenuType(o.util.getUvid()),l=e.spCart.slice(C,C+1),u=0;u<l.length;u++){var c=l[u];c.displayImg=o.util.picUrl+c.displayImg,c.productPrice=o.util.formatProductPrice(c.productPrice,n);var d=o.util.formatProductName(c.productName)+"-d-"+o.util.encodeMenuType(c.productId)+"-"+o.util.encodeMenuType(c.productColorId)+"-"+a+".html"+r;c.href=d}t("#cart_list").html(t("#cartTempl").tmpl(l)),t("#cart_list #color_title").html(t.i18n.map.ColorTitle),v=l[0],v.cmId&&0!=v.cmId?t("#star_wrap").addClass("hide"):t("#star_wrap").removeClass("hide")})}(_)});