"use strict";
require.config(requireConfig),require(["jquery","tmpl","i18n","bootstrap","common"],function(e,i,a,n,s){function r(i){i&&i.usrico?(s.util.setUserImage(e("#current_image"),i.usrico),s.util.setUserImage(e(".big-image img"),i.usrico),s.util.setUserImage(e(".small-image img"),i.usrico)):"0"==i.sex?(s.util.setUserImage(e("#current_image"),"user-female.png"),s.util.setUserImage(e(".big-image img"),"user-female.png"),s.util.setUserImage(e(".small-image img"),"user-female.png")):"1"==i.sex&&(s.util.setUserImage(e("#current_image"),"user-male.png"),s.util.setUserImage(e(".big-image img"),"user-male.png"),s.util.setUserImage(e(".small-image img"),"user-male.png"))}function t(e){e.size>p?g(e,m):o(e,m)}function u(i){var a=window.URL||window.webkitURL,n=a.createObjectURL(i);e("#current_image").attr("src",n)}function o(e,i){var a=new FileReader;a.onload=function(){var n=a.result;i(n,e.name)},a.readAsDataURL(e)}function g(i,a){if("undefined"==typeof FileReader)console.log("The current browser kernel does not support base64 image compression"),o(i,a);else try{var n=new FileReader;n.onload=function(n){var s=e("<img/>");s.load(function(){var e=document.createElement("canvas"),n=e.getContext("2d"),s=0,r=0,t=0,u=0,o="";e.width=100,e.height=100,n.clearRect(0,0,100,100),this.width>100?(s=Math.round(100),r=100,t=Math.round((s-100)/2)):(r=Math.round(100),s=100,u=Math.round((r-100)/2)),n.drawImage(this,t,u,s,r);var o=e.toDataURL("image/jpeg");a(o,i.name)}),s.attr("src",n.target.result)},n.readAsDataURL(i)}catch(e){console.log("Compression failed!"),o(i,a)}}function m(i,a){var n=c(i,a),t=new FormData;t.append("file",n),t.append("userId",s.util.getUserId()),s.dao.upUserIcon(t,function(i){if(null!==i){var a=sessionStorage.userInfo;a&&(a=JSON.parse(a),a.usrico=i),sessionStorage.userInfo=JSON.stringify(a),r(a),e("#save_success_mask").removeClass("hide")}},null,function(){e("#upload_input").val("")})}function l(){s.dao.upUserIconName({userId:s.util.getUserId(),defaultname:v},function(i){if(null!==i){var a=sessionStorage.userInfo;a&&(a=JSON.parse(a),a.usrico=v),sessionStorage.userInfo=JSON.stringify(a),r(a),e("#save_success_mask").removeClass("hide")}},null)}function c(e,i){for(var a=e.split(","),n=a[0].match(/:(.*?);/)[1],s=atob(a[1]),r=s.length,t=new Uint8Array(r);r--;)t[r]=s.charCodeAt(r);return new File([t],i,{type:n})}s.initLoginStatus(function(e){if(e){if(e&&sessionStorage.userInfo){var i=JSON.parse(sessionStorage.userInfo);r(i)}}else window.location.href="../../../login.html"});var d=4194304,p=102400,f=null,v=null;!function(){var i=["user-image-1.png","user-image-2.png","user-image-3.png","user-image-4.png","user-image-5.png","user-image-6.png","user-image-7.png","user-image-8.png","user-image-9.png","user-image-10.png","user-image-11.png","user-image-12.png","user-image-13.png","user-image-14.png","user-image-15.png","user-image-16.png","user-image-17.png","user-image-18.png","user-image-19.png","user-image-20.png"];e("#recommend_image_list").html(e("#userImageTempl").tmpl(i)),e("#recommend_image_list .image-item").bind("click",function(){e("#recommend_image_list .image-item").removeClass("selected"),e(this).addClass("selected"),v=e(this).find("img").data().data,e("#current_image").attr("src","resources/img/user/"+v),e("#upload_input").val(""),f=null})}(),function(){e("#upload_input").change(function(){var i=document.getElementById("upload_input");if(i.files){var a=i.files[0];a.size>d?(alert(e.i18n.map.CommentMaxFileSize),e("#upload_input").val("")):(f=a,u(a))}}),e("#saveBtn").click(function(){null!=f?t(f):null!==v&&l()}),e("#confirmBtn").click(function(){e("#save_success_mask").addClass("hide")})}(),function(){e(".loading-mask").addClass("hide"),e(".main-wrap").removeClass("invisibility"),e("footer").removeClass("invisibility")}()});